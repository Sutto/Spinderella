// Released under the MIT License
if(!this.JSON){this.JSON={}}(function(){function l(a){return a<10?'0'+a:a}if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+l(this.getUTCMonth()+1)+'-'+l(this.getUTCDate())+'T'+l(this.getUTCHours())+':'+l(this.getUTCMinutes())+':'+l(this.getUTCSeconds())+'Z':null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()}}var o=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,p=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,h,m,r={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},k;function q(c){p.lastIndex=0;return p.test(c)?'"'+c.replace(p,function(a){var b=r[a];return typeof b==='string'?b:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+c+'"'}function n(a,b){var c,d,e,i,j=h,g,f=b[a];if(f&&typeof f==='object'&&typeof f.toJSON==='function'){f=f.toJSON(a)}if(typeof k==='function'){f=k.call(b,a,f)}switch(typeof f){case'string':return q(f);case'number':return isFinite(f)?String(f):'null';case'boolean':case'null':return String(f);case'object':if(!f){return'null'}h+=m;g=[];if(Object.prototype.toString.apply(f)==='[object Array]'){i=f.length;for(c=0;c<i;c+=1){g[c]=n(c,f)||'null'}e=g.length===0?'[]':h?'[\n'+h+g.join(',\n'+h)+'\n'+j+']':'['+g.join(',')+']';h=j;return e}if(k&&typeof k==='object'){i=k.length;for(c=0;c<i;c+=1){d=k[c];if(typeof d==='string'){e=n(d,f);if(e){g.push(q(d)+(h?': ':':')+e)}}}}else{for(d in f){if(Object.hasOwnProperty.call(f,d)){e=n(d,f);if(e){g.push(q(d)+(h?': ':':')+e)}}}}e=g.length===0?'{}':h?'{\n'+h+g.join(',\n'+h)+'\n'+j+'}':'{'+g.join(',')+'}';h=j;return e}}if(typeof JSON.stringify!=='function'){JSON.stringify=function(a,b,c){var d;h='';m='';if(typeof c==='number'){for(d=0;d<c;d+=1){m+=' '}}else if(typeof c==='string'){m=c}k=b;if(b&&typeof b!=='function'&&(typeof b!=='object'||typeof b.length!=='number')){throw new Error('JSON.stringify');}return n('',{'':a})}}if(typeof JSON.parse!=='function'){JSON.parse=function(i,j){var g;function f(a,b){var c,d,e=a[b];if(e&&typeof e==='object'){for(c in e){if(Object.hasOwnProperty.call(e,c)){d=f(e,c);if(d!==undefined){e[c]=d}else{delete e[c]}}}}return j.call(a,b,e)}o.lastIndex=0;if(o.test(i)){i=i.replace(o,function(a){return'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(i.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){g=eval('('+i+')');return typeof j==='function'?f({'':g},''):g}throw new SyntaxError('JSON.parse');}}}());Array.prototype.remove=function(a,b){var c=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,c)};var Spinderella=function(d,e,i,j,g){this.host=d;this.port=e||42340;this.channels=i||[];this.identifier=j;this.buffer="";this.onMessage=g||function(a,b,c){}}Spinderella.prototype={processConnection:function(){if(this.channels&&this.channels.length>0)this.subscribe(this.channels);if(this.identifier)this.identify(this.identifier)},processDisconnection:function(){},receiveData:function(a){this.buffer+=a;if(this.buffer.indexOf("\r\n")>=0){var b=this.buffer.split("\r\n");this.buffer=b.pop()||"";for(var c=0;c<b.length;c++){this.receiveMessage(b[c])}}},receiveMessage:function(a){console.log("Raw Message: "+a);var b=JSON.parse(a);if(b&&b.action){this.handleAction(b.action,(b.data||{}))}},handleAction:function(a,b){switch(a){case'ping':this.performAction("pong");break;case'receive_message':this.onMessage(b.message,b.type,b);break}},performAction:function(a,b){if(!b)b={};var c={"action":a,"data":b};this.socket.send(JSON.stringify(c)+"\r\n")},subscribe:function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this.channels.indexOf(c)<0)this.channels.push(c)}this.performAction("subscribe",{"channels":a})},unsubscribe:function(a){for(var b=0;b<a.length;b++){var c=a[b];var d=this.channels.indexOf(c);if(d>=0)this.channels.remove(d)}this.performAction("unsubscribe",{"channels":a})},identify:function(a){this.performAction("identify",{"identifier":a})}};Spinderella.Orbited=function(a,b,c,d,e){this.client=new Spinderella(a,b,c,d,e);this.client.socket=this}Spinderella.Orbited.prototype={reconnectOn:function(){return[Orbited.Errors.RemoteConnectionFailed,Orbited.Errors.UserConnectionReset,Orbited.Statuses.ServerClosedConnection]},onMessage:function(a){this.client.onMessage=a},connect:function(){this.socket=new TCPSocket();var b=this.client;var c=this;this.socket.onread=function(a){b.receiveData(a)};this.socket.onopen=function(){b.processConnection()};this.socket.onclose=function(a){c.onDisconnect(a)};this.socket.open(b.host,b.port)},onDisconnect:function(a){this.client.processDisconnection();if(this.reconnectOn().indexOf(a)>=0){var b=this;setTimeout(function(){b.connect()},5000)}},send:function(a){this.socket.send(a)}};
