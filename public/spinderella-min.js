// Released under the MIT License
if(!this.JSON)this.JSON={};
(function(){function a(d){return d<10?"0"+d:d}function b(d){h.lastIndex=0;return h.test(d)?'"'+d.replace(h,function(f){var i=q[f];return typeof i==="string"?i:"\\u"+("0000"+f.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+d+'"'}function c(d,f){var i,l,n=j,k,e=f[d];if(e&&typeof e==="object"&&typeof e.toJSON==="function")e=e.toJSON(d);if(typeof o==="function")e=o.call(f,d,e);switch(typeof e){case "string":return b(e);case "number":return isFinite(e)?String(e):"null";case "boolean":case "null":return String(e);case "object":if(!e)return"null";
j+=p;k=[];if(Object.prototype.toString.apply(e)==="[object Array]"){l=e.length;for(d=0;d<l;d+=1)k[d]=c(d,e)||"null";f=k.length===0?"[]":j?"[\n"+j+k.join(",\n"+j)+"\n"+n+"]":"["+k.join(",")+"]";j=n;return f}if(o&&typeof o==="object"){l=o.length;for(d=0;d<l;d+=1){i=o[d];if(typeof i==="string")if(f=c(i,e))k.push(b(i)+(j?": ":":")+f)}}else for(i in e)if(Object.hasOwnProperty.call(e,i))if(f=c(i,e))k.push(b(i)+(j?": ":":")+f);f=k.length===0?"{}":j?"{\n"+j+k.join(",\n"+j)+"\n"+n+"}":"{"+k.join(",")+"}";
j=n;return f}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var g=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
h=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j,p,q={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},o;if(typeof JSON.stringify!=="function")JSON.stringify=function(d,f,i){var l;p=j="";if(typeof i==="number")for(l=0;l<i;l+=1)p+=" ";else if(typeof i==="string")p=i;if((o=f)&&typeof f!=="function"&&(typeof f!=="object"||typeof f.length!=="number"))throw new Error("JSON.stringify");return c("",
{"":d})};if(typeof JSON.parse!=="function")JSON.parse=function(d,f){function i(l,n){var k,e,m=l[n];if(m&&typeof m==="object")for(k in m)if(Object.hasOwnProperty.call(m,k)){e=i(m,k);if(e!==undefined)m[k]=e;else delete m[k]}return f.call(l,n,m)}g.lastIndex=0;if(g.test(d))d=d.replace(g,function(l){return"\\u"+("0000"+l.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(d.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){d=eval("("+d+")");return typeof f==="function"?i({"":d},""):d}throw new SyntaxError("JSON.parse");}})();Array.prototype.remove=function(a,b){b=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,b)};var Spinderella=function(a,b,c,g,h){this.host=a;this.port=b||42340;this.channels=c||[];this.identifier=g;this.buffer="";this.onMessage=h||function(){}};
Spinderella.Util={loadJS:function(a,b){var c=document.createElement("script");c.type="text/javascript";c.src=a;c.onload=b;document.getElementsByTagName("head")[0].appendChild(c)}};
Spinderella.prototype={processConnection:function(){this.channels&&this.channels.length>0&&this.subscribe(this.channels);this.identifier&&this.identify(this.identifier)},processDisconnection:function(){},receiveData:function(a){this.buffer+=a;if(this.buffer.indexOf("\r\n")>=0){a=this.buffer.split("\r\n");this.buffer=a.pop()||"";for(var b=0;b<a.length;b++)this.receiveMessage(a[b])}},receiveMessage:function(a){if((a=JSON.parse(a))&&a.action)this.handleAction(a.action,a.data||{})},handleAction:function(a,
b){switch(a){case "ping":this.performAction("pong");break;case "receive_message":this.onMessage(b.message,b.type,b);break}},performAction:function(a,b){b||(b={});this.socket.send(JSON.stringify({action:a,data:b})+"\r\n")},subscribe:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.channels.indexOf(c)<0&&this.channels.push(c)}this.performAction("subscribe",{channels:a})},unsubscribe:function(a){for(var b=0;b<a.length;b++){var c=this.channels.indexOf(a[b]);c>=0&&this.channels.remove(c)}this.performAction("unsubscribe",
{channels:a})},identify:function(a){this.performAction("identify",{identifier:a})}};Spinderella.Silenced=function(){this.client=new Spinderella;this.client.socket=this};Spinderella.Silenced.isUseable=function(){return true};Spinderella.Silenced.implementationName="Silenced";Spinderella.Silenced.prototype={onMessage:function(){},connect:function(){},onDisconnect:function(){},send:function(){}};Spinderella.Orbited=function(a,b,c,g,h){this.client=new Spinderella(a,b,c,g,h);this.client.socket=this};
Spinderella.Orbited.isUseable=function(){return Spinderella.Orbited.javascriptURL!==null};Spinderella.Orbited.javascriptURL=null;Spinderella.Orbited.orbitedHost=null;Spinderella.Orbited.orbitedPort=null;Spinderella.Orbited.implementationName="Orbited";
Spinderella.Orbited.prototype={reconnectOn:function(){return[Orbited.Errors.RemoteConnectionFailed,Orbited.Errors.UserConnectionReset,Orbited.Statuses.ServerClosedConnection]},onMessage:function(a){this.client.onMessage=a},connect:function(a){var b=this,c=this.client,g=function(){if(Spinderella.Orbited.orbitedHost)Orbited.settings.hostname=Spinderella.Orbited.orbitedHost;if(Spinderella.Orbited.orbitedPort)Orbited.settings.port=Spinderella.Orbited.orbitedPort;b.socket=new Orbited.TCPSocket;if(typeof a!=
"function")a=function(){};b.socket.onread=function(h){c.receiveData(h)};b.socket.onopen=function(){c.processConnection();a()};b.socket.onclose=function(h){b.onDisconnect(h)};b.socket.open(c.host,c.port)};typeof Orbited!="undefined"?g():Spinderella.Util.loadJS(Spinderella.Orbited.javascriptURL,g)},onDisconnect:function(a){this.client.processDisconnection();if(this.reconnectOn().indexOf(a)>=0){var b=this;setTimeout(function(){b.connect()},5E3)}},send:function(a){this.socket.send(a)}};
Spinderella.jsSocket=function(a,b,c,g,h){this.client=new Spinderella(a,b,c,g,h);this.client.socket=this};Spinderella.jsSocket.flashURL=null;Spinderella.jsSocket.javascriptURL=null;Spinderella.jsSocket.implementationName="jsSocket";
Spinderella.jsSocket.isUseable=function(){if(Spinderella.jsSocket.flashURL==null||Spinderella.jsSocket.javascriptURL==null)return false;var a=navigator;return a.mimeTypes?a.mimeTypes["application/x-shockwave-flash"]!==undefined:a.plugins?a.plugins["Shockwave Flash"]!==undefined:false};
Spinderella.jsSocket.prototype={connect:function(a){var b=this,c=this.client,g=function(){jsSocket.swf=Spinderella.jsSocket.flashURL;b.socket=new jsSocket({keepalive:false,autoreconnect:true});if(typeof a!="function")a=function(){};b.socket.onData=function(h){c.receiveData(h)};b.socket.onOpen=function(){c.processConnection();a()};b.socket.onClose=function(){c.processDisconnection()};b.socket.onLoaded=function(){b.socket.connect(c.host,c.port)}};typeof jsSocket!="undefined"?Spinderella.Util.loadJS(Spinderella.jsSocket.javascriptURL,
g):g()},send:function(a){this.socket.send(a)},onMessage:function(a){this.client.onMessage=a}};Spinderella.WebSocket=function(a,b,c,g,h){this.client=new Spinderella(a,b,c,g,h);this.resourceURL="ws://"+a;if(b!=80)this.resourceURL+=":"+b;this.resourceURL+="/spinderella";this.client.socket=this};Spinderella.WebSocket.isUseable=function(){return typeof WebSocket!="undefined"};Spinderella.WebSocket.implementationName="WebSocket";
Spinderella.WebSocket.prototype={onMessage:function(a){this.client.onMessage=a},connect:function(a){this.socket=new WebSocket(this.resourceURL);var b=this.client,c=this;if(typeof a!="function")a=function(){};this.socket.onmessage=function(g){b.receiveData(g.data+"\r\n")};this.socket.onopen=function(){b.processConnection();a()};this.socket.onclose=function(){c.onDisconnect()}},onDisconnect:function(){this.client.processDisconnection()},send:function(a){this.socket.send(a)}};
Spinderella.Implementations=[Spinderella.WebSocket,Spinderella.jsSocket,Spinderella.Orbited,Spinderella.Silenced];Spinderella.getPreferredImplementation=function(){for(var a,b=0;b<Spinderella.Implementations.length;b++){a=Spinderella.Implementations[b];if(a.isUseable&&a.isUseable())return a}};
Spinderella.create=function(a,b,c,g,h){var j=Spinderella.getPreferredImplementation();if(typeof b=="number")b=b;else switch(j){case Spinderella.WebSocket:b=b.websocket;break;default:b=b.base;break}return new j(a,b,c,g,h)};
