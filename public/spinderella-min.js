// Released under the MIT License
if(!this.JSON)this.JSON={};
(function(){function a(d){return d<10?"0"+d:d}function b(d){f.lastIndex=0;return f.test(d)?'"'+d.replace(f,function(g){var i=q[g];return typeof i==="string"?i:"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+d+'"'}function c(d,g){var i,l,n=j,k,e=g[d];if(e&&typeof e==="object"&&typeof e.toJSON==="function")e=e.toJSON(d);if(typeof o==="function")e=o.call(g,d,e);switch(typeof e){case "string":return b(e);case "number":return isFinite(e)?String(e):"null";case "boolean":case "null":return String(e);case "object":if(!e)return"null";
j+=p;k=[];if(Object.prototype.toString.apply(e)==="[object Array]"){l=e.length;for(d=0;d<l;d+=1)k[d]=c(d,e)||"null";g=k.length===0?"[]":j?"[\n"+j+k.join(",\n"+j)+"\n"+n+"]":"["+k.join(",")+"]";j=n;return g}if(o&&typeof o==="object"){l=o.length;for(d=0;d<l;d+=1){i=o[d];if(typeof i==="string")if(g=c(i,e))k.push(b(i)+(j?": ":":")+g)}}else for(i in e)if(Object.hasOwnProperty.call(e,i))if(g=c(i,e))k.push(b(i)+(j?": ":":")+g);g=k.length===0?"{}":j?"{\n"+j+k.join(",\n"+j)+"\n"+n+"}":"{"+k.join(",")+"}";
j=n;return g}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var h=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
f=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j,p,q={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},o;if(typeof JSON.stringify!=="function")JSON.stringify=function(d,g,i){var l;p=j="";if(typeof i==="number")for(l=0;l<i;l+=1)p+=" ";else if(typeof i==="string")p=i;if((o=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw new Error("JSON.stringify");return c("",
{"":d})};if(typeof JSON.parse!=="function")JSON.parse=function(d,g){function i(l,n){var k,e,m=l[n];if(m&&typeof m==="object")for(k in m)if(Object.hasOwnProperty.call(m,k)){e=i(m,k);if(e!==undefined)m[k]=e;else delete m[k]}return g.call(l,n,m)}h.lastIndex=0;if(h.test(d))d=d.replace(h,function(l){return"\\u"+("0000"+l.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(d.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){d=eval("("+d+")");return typeof g==="function"?i({"":d},""):d}throw new SyntaxError("JSON.parse");}})();Array.prototype.remove=function(a,b){b=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,b)};var Spinderella=function(a,b,c,h,f){this.host=a;this.port=b||42340;this.channels=c||[];this.identifier=h;this.buffer="";this.onMessage=f||function(){}};Spinderella.log=function(){};
Spinderella.Util={loadJS:function(a,b){Spinderella.log("loading javascript from",a);var c=document.createElement("script");c.type="text/javascript";c.src=a;c.onload=b;document.getElementsByTagName("head")[0].appendChild(c)}};
Spinderella.prototype={processConnection:function(){Spinderella.log("-> processConnection");this.channels&&this.channels.length>0&&this.subscribe(this.channels);this.identifier&&this.identify(this.identifier)},processDisconnection:function(){Spinderella.log("-> processDisconnection")},receiveData:function(a){Spinderella.log("<<",a);this.buffer+=a;if(this.buffer.indexOf("\r\n")>=0){a=this.buffer.split("\r\n");this.buffer=a.pop()||"";for(var b=0;b<a.length;b++)this.receiveMessage(a[b])}},receiveMessage:function(a){Spinderella.log("Got raw message:",
a);if((a=JSON.parse(a))&&a.action){Spinderella.log("Handling action:",a.action);this.handleAction(a.action,a.data||{})}},handleAction:function(a,b){switch(a){case "ping":Spinderella.log("Oh noes! ping time");this.performAction("pong");break;case "receive_message":this.onMessage(b.message,b.type,b);break}},performAction:function(a,b){Spinderella.log("Performing action with name =",a,"and data =",b);b||(b={});a=JSON.stringify({action:a,payload:b});Spinderella.log(">>",a);this.socket.send(a+"\r\n")},
subscribe:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.channels.indexOf(c)<0&&this.channels.push(c)}Spinderella.log("Subscribing to channels: ",a);this.performAction("subscribe",{channels:a})},unsubscribe:function(a){for(var b=0;b<a.length;b++){var c=this.channels.indexOf(a[b]);c>=0&&this.channels.remove(c)}Spinderella.log("Unsubscribing from",a);this.performAction("unsubscribe",{channels:a})},identify:function(a){Spinderella.log("Identifying as",a);this.performAction("identify",{identifier:a})}};
Spinderella.Mock=function(){this.client=new Spinderella;this.client.socket=this};Spinderella.Mock.isUseable=function(){return true};Spinderella.Mock.implementationName="Mock";Spinderella.Mock.prototype={onMessage:function(){Spinderella.log("Adding onMessage callback")},connect:function(){Spinderella.log("Mock connected.")},onDisconnect:function(){Spinderella.log("Mock disconnected.")},send:function(a){Spinderella.log("Mock is sending data:",a)}};
Spinderella.Orbited=function(a,b,c,h,f){this.client=new Spinderella(a,b,c,h,f);this.client.socket=this};Spinderella.Orbited.isUseable=function(){return Spinderella.Orbited.javascriptURL!==null};Spinderella.Orbited.javascriptURL=null;Spinderella.Orbited.orbitedHost=null;Spinderella.Orbited.orbitedPort=null;Spinderella.Orbited.implementationName="Orbited";
Spinderella.Orbited.prototype={reconnectOn:function(){return[Orbited.Errors.RemoteConnectionFailed,Orbited.Errors.UserConnectionReset,Orbited.Statuses.ServerClosedConnection]},onMessage:function(a){this.client.onMessage=a},connect:function(a){var b=this,c=this.client,h=function(){if(Spinderella.Orbited.orbitedHost)Orbited.settings.hostname=Spinderella.Orbited.orbitedHost;if(Spinderella.Orbited.orbitedPort)Orbited.settings.port=Spinderella.Orbited.orbitedPort;b.socket=new Orbited.TCPSocket;if(typeof a!=
"function")a=function(){};b.socket.onread=function(f){c.receiveData(f)};b.socket.onopen=function(){c.processConnection();a()};b.socket.onclose=function(f){b.onDisconnect(f)};b.socket.open(c.host,c.port)};typeof Orbited!="undefined"?h():Spinderella.Util.loadJS(Spinderella.Orbited.javascriptURL,h)},onDisconnect:function(a){this.client.processDisconnection();if(this.reconnectOn().indexOf(a)>=0){var b=this;setTimeout(function(){b.connect()},5E3)}},send:function(a){this.socket.send(a)}};
Spinderella.JSSocket=function(a,b,c,h,f){this.client=new Spinderella(a,b,c,h,f);this.client.socket=this};Spinderella.JSSocket.flashURL=null;Spinderella.JSSocket.javascriptURL=null;Spinderella.JSSocket.implementationName="JSSocket";
Spinderella.JSSocket.isUseable=function(){if(Spinderella.JSSocket.flashURL==null||Spinderella.JSSocket.javascriptURL==null)return false;Spinderella.log("Checking for Flash");var a=navigator;return a.mimeTypes?a.mimeTypes["application/x-shockwave-flash"]!==undefined:a.plugins?a.plugins["Shockwave Flash"]!==undefined:false};
Spinderella.JSSocket.prototype={connect:function(a){Spinderella.log("Connecting via flash");var b=this,c=this.client,h=function(){JSSocket.swf=Spinderella.JSSocket.flashURL;Spinderella.log("Set JSSocket swf to",JSSocket.swf);JSSocket.logger=function(){Spinderella.log.apply(Spinderella,arguments)};Spinderella.log("Created socket and setting callbacks");if(typeof a!="function")a=function(){};b.socket=JSSocket.connect(c.host,c.port,function(f){f.onData(function(j){c.receiveData(j)});f.onOpen(function(){c.processConnection();
a()});f.onClose(function(){c.processDisconnection()})})};if(typeof JSSocket=="undefined"){Spinderella.log("Lazy loading JSSocket");Spinderella.Util.loadJS(Spinderella.JSSocket.javascriptURL,h)}else h()},send:function(a){this.socket.send(a)},onMessage:function(a){this.client.onMessage=a}};
Spinderella.WebSocket=function(a,b,c,h,f){this.client=new Spinderella(a,b,c,h,f);this.resourceURL="ws://"+a;if(b!=80)this.resourceURL+=":"+b;this.resourceURL+="/spinderella";Spinderella.log("WebSocket uses",this.resourceURL);this.client.socket=this};Spinderella.WebSocket.isUseable=function(){return typeof WebSocket!="undefined"};Spinderella.WebSocket.implementationName="WebSocket";
Spinderella.WebSocket.prototype={onMessage:function(a){this.client.onMessage=a},connect:function(a){Spinderella.log("Creating websocket");this.socket=new WebSocket(this.resourceURL);var b=this.client,c=this;Spinderella.log("Setting callbacks");if(typeof a!="function")a=function(){};this.socket.onmessage=function(h){b.receiveData(h.data+"\r\n")};this.socket.onopen=function(){b.processConnection();a()};this.socket.onclose=function(){c.onDisconnect()}},onDisconnect:function(){Spinderella.log("Handling websocket disconnection");
this.client.processDisconnection()},send:function(a){this.socket.send(a)}};Spinderella.Implementations=[Spinderella.WebSocket,Spinderella.JSSocket,Spinderella.Orbited,Spinderella.Mock];Spinderella.getPreferredImplementation=function(){for(var a,b=0;b<Spinderella.Implementations.length;b++){a=Spinderella.Implementations[b];Spinderella.log("Checking if",a.implementationName,"is useable");if(a.isUseable&&a.isUseable()){Spinderella.log("Using",a.implementationName);return a}}};
Spinderella.create=function(a,b,c,h,f){var j=Spinderella.getPreferredImplementation();if(typeof b=="number")b=b;else switch(j){case Spinderella.WebSocket:b=b.websocket;break;default:b=b.base;break}Spinderella.log("Connection to",a,b);return new j(a,b,c,h,f)};
